### 早期的数据库系统：

两阶段提交（2PC）和三阶段提交（3PC）。
- 通过预写式日志机制来实现节点间的事务一致性及故障恢复。
- 设计初衷是处理节点因工作异常或网络问题而无响应。
- 假设所有节点基本上是诚实的，只是可能会因为技术故障而无法完成其任务。
#### 两阶段提交（2PC）

**第一阶段**

- 事务管理器（TM）向所有资源管理器（RM）发送“准备好提交事务吗？”的询问。
- 各参与节点回应“是”（Yes）或“否”（No）。

**第二阶段**

- 如果所有参与节点的回应都是“Yes”，则 TM 向所有 RM 广播“提交（Commit）”指令。
- 如果任一节点回应“No”或未在规定时间内回应，则 TM 广播“回滚（Rollback）”指令。
- 完成指令后，参与节点向 TM 发送确认回应（Ack），TM 随后标记事务为已完成
#### 三阶段提交

为了解决两阶段提交（2PC）中存在的阻塞和潜在的脑裂问题，三阶段提交（3PC）协议被开发出来。该协议通过引入额外的预提交阶段和参与者的超时机制来增强系统的鲁棒性，并使用预写日志来保障节点在故障后能从日志中恢复到正确的状态。

**第一阶段：询问提交**

- 协调节点向所有参与节点发送“CanCommit”指令以询问是否准备好提交事务，同时启动超时计时。
- 若在超时期限内未收到协调节点的下一步指令，参与节点将终止事务。

**第二阶段：预提交**

- 如果所有参与者都回答“Yes”，协调节点随后发出“PreCommit”指令。
- 参与者在将事务的 undo 和 redo 日志写入稳定存储后回复“Yes”或“No”，并在此之后启动另一个超时计时。
- 如果在此阶段超时未收到协调节点的最终指令，参与者将根据自己的预提交状态直接提交事务。

> 预提交是指参与者将事务的 undo 和 redo 日志写入本地的稳定存储介质，但不进行真正提交；同时这里的参与者超时后回滚是与两阶段提交的「阻塞等待」的不同之处。

**第三阶段：最终提交**

- 如果所有参与者在预提交阶段都回复“Yes”，协调节点则发出“DoCommit”指令。
- 参与者收到后执行最终提交，向协调者发送最终的确认响应（Ack）。
- 如果有参与者回答“No”或响应超时，协调节点会指示所有参与者根据 undo 日志回滚事务。
### 拜占庭将军问题

拜占庭将军问题是通过以下场景来说明的：若干将军各领一支军队围攻一个城市，他们只能通过信使传递信息。为了成功攻占城市，所有将军必须同意攻击或撤退的统一行动计划。然而，一些将军可能是叛徒，会故意发送虚假信息以迷惑其他忠诚的将军。解决这一问题的算法必须能确保即便存在叛徒，忠诚的将军们也能达成一致的决策。

除了叛徒，还可能存在以下问题：

- 叛徒伪造其他将军身份投票
- 即使保证所有将军忠诚，也不能排除信使被敌人截杀或被间谍替换

因此很难通过保证人员可靠性及通讯可靠性来解决问题，只能通过收到的投票情况来做决定。

**问题建模**

在解决拜占庭将军问题的过程中，问题的建模是至关重要的一步。这一问题模型设定了一组将军，其中包括可能的叛徒，需要通过共识来决定共同的行动方案。关键在于找到一种算法，满足以下两个核心条件：

- A. 一致性决策：所有忠诚的将军必须达成相同的决策。
- B. 抵抗叛徒干扰：即使存在叛徒，也不能让他们影响忠诚将军做出错误的决策。

只有同时满足这两个条件，我们才能认为有效解决了拜占庭将军问题。在这方面，三位科学家在他们的论文中提出了两种解决方案：

1. 基于口头消息的协议
2. 基于书面消息的协议

>拜占庭错误算是分布式系统中一个最极端的问题，某个算法解决了这个问题，就可以说这个共识算法是足够健壮的。


###  通信模型

在分布式系统中，有效的通信是系统性能和可靠性的关键因素。通信模型定义了消息传递的时效性及其对系统的限制。基本上，可以将通信模型分为三种类型：同步、异步和部分同步。
###  FLP 定理

FLP 定理：在一个异步通信网络中，只要存在一个故障节点，就不存在一种完美的共识算法可以正确地终止（使所有节点达成一致）。

>如果你永远无法区分“对方没回消息”和“网络太慢”，  那你就无法保证大家最终一定能达成共识。

### CAP 定理

一个系统不可能同时满足以下三个属性：

- **强一致性（Consistency）**：确保所有节点在完成写操作后能返回最新的数据。若不是最新的数据，则返回错误。这种级别的一致性要求非常高，实际应用中往往采用更灵活、成本更低的一致性模型，如最终一致性。
- **可用性（Availability）**：系统必须确保对客户端的每个请求都能在一定时间内给予响应，无论请求的结果如何，保证服务的持续可用。
- **分区容错性（Partition tolerance）**：即使出现网络分区，部分节点之间失去通信，系统仍需能继续运行。

CAP 定理的核心观点是，在分布式系统的设计中，不可能同时完全实现这三个目标。因此，设计者需要根据系统的具体需求和环境条件作出选择和取舍。


### 🔺为什么三者不能同时满足？

关键矛盾：  
当网络断了（P 发生），两个节点之间**无法同步数据**。  
这时系统必须在以下两者间做选择：

#### 🟥选择 C（一致性）

网络断线 → 数据无法同步  
→ 为了保持一致性  
→ **拒绝部分请求（牺牲可用性 A）**

⚡例子：  
你到一个店购买时，对方因为无法同步数据，告诉你：  
“系统正在维护，请稍后再来。”  
就保持一致了，但 **不可用了**。

这就是 **CP 系统**。

### 🟦选择 A（可用性）

网络断线 → 数据无法同步  
→ 为了保证每个店都继续营业  
→ **允许返回旧数据（牺牲一致性 C）**

⚡例子：  
你两家店各买一个苹果，都说库存还有。  
但其实他们的库存没同步，数据不一致。

这就是 **AP 系统**。

### 📌所以结果是：

> 网络一旦发生问题（P）  
> 你必须在 C 和 A 中选一个  
> **不可能同时拥有 CAP。**

现实是：

- P → 必选
    
- C vs A → 做业务决策
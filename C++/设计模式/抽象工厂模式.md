[10 tools called]

ç°åœ¨æˆ‘å·²ç»äº†è§£äº†æ•´ä¸ªç›¸æœºåŸºç¡€è®¾æ–½çš„ç»“æ„ã€‚è®©æˆ‘ä¸ºä½ æ€»ç»“è¿™ä¸ª**æŠ½è±¡ç›¸æœºæ¨¡å¼**çš„æ¶æ„ï¼š

---

# ğŸ“ åŸºç¡€è®¾æ–½ - æŠ½è±¡ç›¸æœºæ¨¡å¼ç¬”è®°

## ä¸€ã€æ•´ä½“æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       CameraManagerï¼ˆå•ä¾‹ï¼‰                        â”‚
â”‚                    ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç›¸æœºå®ä¾‹                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ ä½¿ç”¨
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ICameraFactoryï¼ˆæŠ½è±¡å·¥å‚ï¼‰                    â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚     CLXCameraFactory   LHYXCameraFactory   (UVC...)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ åˆ›å»º
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ICameraï¼ˆæ ¸å¿ƒæ¥å£ï¼‰                          â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚    ContextCamera â†â”€â”€ DriverCamera â†â”€â”€ ICameraDriver              â”‚
â”‚    (è£…é¥°å™¨å±‚)          (é€‚é…å™¨å±‚)      (é©±åŠ¨å±‚æ¥å£)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€æ ¸å¿ƒå±‚çº§ç»“æ„

### 1. é©±åŠ¨å±‚ (`ICameraDriver`)

**ä½ç½®**ï¼š`infrastructure/camera/driver/icamera_driver.h`

**èŒè´£**ï¼šç›´æ¥ä¸ç¡¬ä»¶äº¤äº’çš„æœ€åº•å±‚æŠ½è±¡

```cpp
class ICameraDriver {
  virtual bool open() = 0;
  virtual void close() = 0;
  virtual CameraRawData capture() = 0;  // è¿”å› {image + timestamp_ns}
  virtual bool checkConnection() = 0;
  virtual std::string getVersion() = 0;
  virtual std::string getMac() = 0;
  // æ ‡å®šå‚æ•°æ¥å£
  virtual std::optional<json> getCalibration() = 0;
  virtual bool setCalibration(const json& params) = 0;
};
```

**å…·ä½“å®ç°**ï¼š
- `CLXDriver` - CLXå‚å®¶ç›¸æœºé©±åŠ¨ï¼ˆH264ç¡¬è§£ï¼‰
- `LHYXDriver` - LHYXå‚å®¶ç›¸æœºé©±åŠ¨ï¼ˆH264ç¡¬è§£ï¼‰
- `UVCDriver` - USBæ‘„åƒå¤´é©±åŠ¨ï¼ˆOpenCVè¯»å–ï¼‰

---

### 2. é€‚é…å™¨å±‚ (`DriverCamera`)

**ä½ç½®**ï¼š`infrastructure/camera/core/driver_camera.h`

**èŒè´£**ï¼šå°† `ICameraDriver` é€‚é…ä¸º `ICamera` æ¥å£ï¼Œæ·»åŠ çŠ¶æ€ç®¡ç†

```cpp
class DriverCamera : public ICamera {
  std::unique_ptr<ICameraDriver> driver_;  // æŒæœ‰é©±åŠ¨
  CameraState state_;                       // çŠ¶æ€ç®¡ç†
  CameraInfo info_;                         // ç›¸æœºä¿¡æ¯
  
  // é€‚é… Driver â†’ ICamera æ–¹æ³•
  bool open() { return driver_->open(); }
  CameraRawData captureFrame() { return driver_->capture(); }
};
```

**å…³é”®ç‰¹æ€§**ï¼š
- ä½¿ç”¨ `std::unique_ptr` ç®¡ç†é©±åŠ¨ç”Ÿå‘½å‘¨æœŸ
- æ·»åŠ  `CameraState` çŠ¶æ€æœºï¼ˆUNINITIALIZEDâ†’STREAMINGâ†’ERRORï¼‰
- å¯è®¾ç½® `CameraVendor` å‚å®¶ä¿¡æ¯

---

### 3. è£…é¥°å™¨å±‚ (`ContextCamera`)

**ä½ç½®**ï¼š`infrastructure/camera/core/context_camera.h`

**èŒè´£**ï¼šæ·»åŠ ä½ç½®å’Œç±»å‹ä¸Šä¸‹æ–‡ä¿¡æ¯

```cpp
class ContextCamera : public ICamera {
  ICamera::Ptr core_;          // è£…é¥°çš„æ ¸å¿ƒç›¸æœº
  CameraPlacement placement_;  // å®‰è£…ä½ç½® (Front/Back/Left/Right)
  CameraType type_;            // å…‰å­¦ç±»å‹ (MONO/STEREO)
  
  CameraInfo getInfo() const {
    auto info = core_->getInfo();
    info.placement = placement_;  // æ³¨å…¥ä½ç½®ä¿¡æ¯
    info.camera_type = type_;     // æ³¨å…¥ç±»å‹ä¿¡æ¯
    return info;
  }
};
```

**è®¾è®¡æ„å›¾**ï¼š
- **èŒè´£åˆ†ç¦»**ï¼šé©±åŠ¨å±‚ä¸å…³å¿ƒä½ç½®ï¼Œä½ç½®ä¿¡æ¯åœ¨è£…é¥°å±‚æ³¨å…¥
- **é€æ˜ä»£ç†**ï¼šæ‰€æœ‰ `ICamera` æ–¹æ³•å§”æ‰˜ç»™ `core_`

---

### 4. ç»Ÿä¸€æ¥å£å±‚ (`ICamera`)

**ä½ç½®**ï¼š`infrastructure/camera/core/icamera.h`

**èŒè´£**ï¼šå®šä¹‰ç›¸æœºçš„ç»Ÿä¸€æ“ä½œæ¥å£

```cpp
class ICamera {
  using Ptr = std::shared_ptr<ICamera>;
  
  // ç”Ÿå‘½å‘¨æœŸ
  virtual bool open() = 0;
  virtual bool close() = 0;
  virtual bool reset() = 0;
  
  // é‡‡é›†
  virtual CameraRawData captureFrame() = 0;
  
  // çŠ¶æ€ä¸ä¿¡æ¯
  virtual bool checkConnection() const = 0;
  virtual CameraState getState() const = 0;
  virtual CameraInfo getInfo() const = 0;
  
  // å‚æ•°
  virtual bool setParameter(const std::string& key, int value) = 0;
  virtual bool getParameter(const std::string& key, int& value) const = 0;
};
```

---

## ä¸‰ã€å·¥å‚æ¨¡å¼

### æŠ½è±¡å·¥å‚ (`ICameraFactory`)

```cpp
class ICameraFactory {
  virtual ICamera::Ptr createCamera(const std::string& ip) = 0;
  virtual ICamera::Ptr createCamera(const std::string& ip,
                                    CameraVendor vendor,
                                    CameraPlacement position,
                                    CameraType type) = 0;
};
```

### å…·ä½“å·¥å‚ï¼ˆä»¥ `CLXCameraFactory` ä¸ºä¾‹ï¼‰

```cpp
ICamera::Ptr createCamera(const std::string& ip, ...) {
  // 1. åˆ›å»ºé©±åŠ¨
  auto driver = std::make_unique<CLXDriver>(ip);
  
  // 2. åŒ…è£…ä¸º DriverCameraï¼ˆé€‚é…å™¨ï¼‰
  auto core = std::make_shared<DriverCamera>(std::move(driver));
  core->setVendor(CameraVendor::CLX);
  
  // 3. åŒ…è£…ä¸º ContextCameraï¼ˆè£…é¥°å™¨ï¼‰
  return std::make_shared<ContextCamera>(core, position, type);
}
```

---

## å››ã€æ•°æ®ç±»å‹

**ä½ç½®**ï¼š`core/camera_types.hpp`

```cpp
// ç›¸æœºçŠ¶æ€
enum class CameraState { UNINITIALIZED, READY, STREAMING, ERROR, DISCONNECTED, UNREACHABLE };

// ç›¸æœºå‚å•†
enum class CameraVendor { UNKNOWN, CLX, LHYX, UVC };

// å®‰è£…ä½ç½®
enum class CameraPlacement { UNKNOWN, Front, Back, Left, Right };

// å…‰å­¦ç±»å‹
enum class CameraType { UNKNOWN, MONO, STEREO };

// åŸå§‹æ•°æ®
struct CameraRawData {
  cv::Mat image;           // BGRå›¾åƒ
  uint64_t timestamp_ns;   // çº³ç§’æ—¶é—´æˆ³ï¼ˆé©±åŠ¨å±‚æ‰“æˆ³ï¼‰
};

// ç›¸æœºä¿¡æ¯
struct CameraInfo {
  std::string name, url, firmware_version, mac_address;
  cv::Size resolution;
  int fps;
  CameraState state;
  CameraVendor vendor;
  CameraPlacement placement;
  CameraType camera_type;
};
```

---

## äº”ã€è®¾è®¡æ¨¡å¼æ€»ç»“

| æ¨¡å¼ | åº”ç”¨ | ä½œç”¨ |
|------|------|------|
| **æŠ½è±¡å·¥å‚** | `ICameraFactory` | åˆ›å»ºä¸åŒå‚å®¶ç›¸æœºï¼Œéš”ç¦»åˆ›å»ºç»†èŠ‚ |
| **ç­–ç•¥æ¨¡å¼** | `ICameraDriver` | ä¸åŒé©±åŠ¨å¯æ’æ‹”æ›¿æ¢ |
| **é€‚é…å™¨æ¨¡å¼** | `DriverCamera` | å°†é©±åŠ¨æ¥å£é€‚é…ä¸ºç»Ÿä¸€ç›¸æœºæ¥å£ |
| **è£…é¥°å™¨æ¨¡å¼** | `ContextCamera` | é€æ˜æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯ |
| **å•ä¾‹æ¨¡å¼** | `CameraManager` | å…¨å±€å”¯ä¸€ç®¡ç†å™¨ |
| **Pimpl** | `UVCCamera` | éšè—å®ç°ç»†èŠ‚ |

---

## å…­ã€ç›®å½•ç»“æ„

```
infrastructure/camera/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ icamera.h           # ç»Ÿä¸€æ¥å£
â”‚   â”œâ”€â”€ driver_camera.h     # é€‚é…å™¨å±‚
â”‚   â””â”€â”€ context_camera.h    # è£…é¥°å™¨å±‚
â”œâ”€â”€ driver/
â”‚   â”œâ”€â”€ icamera_driver.h    # é©±åŠ¨æ¥å£
â”‚   â”œâ”€â”€ clx_driver.h        # CLXé©±åŠ¨
â”‚   â”œâ”€â”€ lhyx_driver.h       # LHYXé©±åŠ¨
â”‚   â””â”€â”€ uvc_driver.h        # UVCé©±åŠ¨
â”œâ”€â”€ factory/
â”‚   â”œâ”€â”€ icamera_factory.h   # æŠ½è±¡å·¥å‚
â”‚   â”œâ”€â”€ clx_camera_factory.h
â”‚   â””â”€â”€ lhyx_camera_factory.h
â”œâ”€â”€ util/
â”‚   â”œâ”€â”€ mpp_h264_decoder.h  # ç¡¬è§£ç å™¨
â”‚   â””â”€â”€ ipcamera_checker.h  # ç½‘ç»œæ£€æµ‹
â””â”€â”€ camera_manager.hpp      # å•ä¾‹ç®¡ç†å™¨
```

---

## ä¸ƒã€å…³é”®è®¾è®¡å†³ç­–

1. **æ—¶é—´æˆ³åœ¨é©±åŠ¨å±‚æ‰“æˆ³** - ç¡®ä¿æœ€é«˜ç²¾åº¦ï¼Œåæ˜ å›¾åƒå®é™…é‡‡é›†æ—¶é—´
2. **IPæŸ¥è¯¢device_num** - é©±åŠ¨åªéœ€IPå‚æ•°ï¼Œæ˜ å°„å…³ç³»ç”±ç®¡ç†å™¨ç»´æŠ¤
3. **åˆ†å±‚èŒè´£æ¸…æ™°** - é©±åŠ¨å±‚ç®¡ç¡¬ä»¶ã€é€‚é…å±‚ç®¡çŠ¶æ€ã€è£…é¥°å±‚ç®¡ä¸Šä¸‹æ–‡
4. **æ”¯æŒçƒ­æ’æ‹”** - `CameraManager` æ”¯æŒåŠ¨æ€ `initializeCamera`/`destroyCamera`
5. **çº¿ç¨‹å®‰å…¨** - å„å±‚ä½¿ç”¨ `std::mutex` ä¿æŠ¤å…±äº«æ•°æ®
## 📊 双目vs单目初始化对比

| 阶段         | 单目+IMU                 | 双目+IMU                 | 双目                     |
| ---------- | ---------------------- | ---------------------- | ---------------------- |
| IMU激励检查    | ✅ initialStructure()   | ❌ 无                    | ❌ 无                    |
| 相对位姿估计     | ✅ relativePose()       | ❌ 无                    | ❌ 无                    |
| Global SFM | ✅ construct()          | ❌ 无                    | ❌ 无                    |
| PnP定位      | ❌ 无                    | ✅ initFramePoseByPnP() | ✅ initFramePoseByPnP() |
| 三角化        | ✅ SFM中进行               | ✅ triangulate()        | ✅ triangulate()        |
| 陀螺仪偏差      | ✅ solveGyroscopeBias() | ✅ solveGyroscopeBias() | ❌ 无                    |
| 视觉IMU对齐    | ✅ visualInitialAlign() | ❌ 无                    | ❌ 无                    |

https://zhuanlan.zhihu.com/p/412877911

![[vinsfusion-初始化1.png]]
![[vinsfusion-初始化2.png]]



# VINS Fusion 初始化知识总结

## 一、三种初始化模式对比

| 模式         | 条件                   | 核心流程                       | 难度     |
| ---------- | -------------------- | -------------------------- | ------ |
| **单目+IMU** | `!stereo && use_imu` | SFM重建 → 视觉IMU对齐 → 尺度恢复     | ⭐⭐⭐ 最难 |
| **双目+IMU** | `stereo && use_imu`  | PnP求位姿 → 双目三角化 → 陀螺仪bias标定 | ⭐⭐ 中等  |
| **纯双目**    | `stereo && !use_imu` | PnP求位姿 → 双目三角化 → 优化        | ⭐ 最简单  |

---

## 二、单目+IMU 初始化流程

```
┌────────────────────────────────────────────────────────────────┐
│  1. IMU可观测性检查                                              │
│     └── 加速度方差 < 0.25 → 警告激励不足                          │
├────────────────────────────────────────────────────────────────┤
│  2. 寻找足够视差的帧对 (relativePose)                             │
│     └── 视差 > 30像素 + 对极几何求解 R, t                         │
├────────────────────────────────────────────────────────────────┤
│  3. 纯视觉SFM重建 (GlobalSFM::construct)                         │
│     ├── 以帧l和最新帧为基准建立两视图几何                           │
│     ├── 向前向后PnP求解所有帧位姿                                  │
│     ├── 三角化所有特征点                                         │
│     └── 全局BA优化                                              │
├────────────────────────────────────────────────────────────────┤
│  4. 视觉-IMU对齐 (visualInitialAlign)                           │
│     ├── solveGyroscopeBias: 求解陀螺仪bias                      │
│     ├── LinearAlignment: 求解重力方向、尺度s、速度                 │
│     ├── RefineGravity: 精化重力方向                              │
│     └── 尺度缩放 + 重力对齐（旋转世界坐标系）                       │
└────────────────────────────────────────────────────────────────┘
```

**关键点**：单目无法直接获得深度，需要通过IMU对齐恢复**尺度**。

---

## 三、双目+IMU 初始化流程

```
┌────────────────────────────────────────────────────────────────┐
│                     帧0 (frame_count = 0)                       │
├────────────────────────────────────────────────────────────────┤
│  initFramePoseByPnP(0)  → frameCnt > 0 不满足，跳过             │
│  triangulate(0)         → 双目三角化，得到初始3D点              │
│                           (位姿用初始值：原点)                   │
└────────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────────┐
│                     帧1~9 (frame_count = 1~9)                   │
├────────────────────────────────────────────────────────────────┤
│  initFramePoseByPnP(n)  → 用已有3D点 + 当前帧2D点               │
│                         → PnP求解当前帧位姿                     │
│  triangulate(n)         → 双目三角化当前帧新特征                │
│                         → 3D点数量增加                          │
└────────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────────┐
│                     帧10 (frame_count = WINDOW_SIZE)            │
├────────────────────────────────────────────────────────────────┤
│  solveGyroscopeBias()   → 利用视觉旋转约束求陀螺仪bias          │
│  repropagate()          → 用新bias重新积分                      │
│  optimization()         → 全局BA优化                            │
│  solver_flag = NON_LINEAR  → 初始化完成！                       │
└────────────────────────────────────────────────────────────────┘
```


```
┌─────────────────────────────────────────────────────────────────┐
│                    陀螺仪Bias标定原理                            │
├─────────────────────────────────────────────────────────────────┤
│ solveGyroscopeBias()                                                           │                                                               │                
│   帧i ─────────────────────────────────► 帧j                    │
│    │                                      │                     │
│    │  视觉: q_ij = R_i^T * R_j           │                     │
│    │  (PnP求得，准确但低频)               │                     │
│    │                                      │                     │
│    └──────── IMU预积分: Δq_ij ───────────┘                     │
│              (高频但有bias)                                      │
│                                                                 │
│   约束: q_ij ≈ Δq_ij ⊗ correction(δbg)                         │
│                                                                 │
│   多帧累加 → 最小二乘求解 δbg                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**关键点**：双目已知基线，可直接获得**真实尺度深度**，无需SFM和尺度恢复。

---

```

┌─────────────────────────────────────────────────────────────────┐
│           双目+IMU 初始化最后阶段详解                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  输入: 10帧的位姿 Ps[], Rs[] (由PnP求得)                        │
│        10帧的IMU预积分 (用初始bias=0积分)                       │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ Step 1: solveGyroscopeBias()                              │ │
│  │                                                           │ │
│  │   遍历相邻帧:                                              │ │
│  │     视觉旋转 q_ij = R_i^T * R_j                           │ │
│  │     IMU旋转  Δq_ij (预积分)                               │ │
│  │     残差 = 2*(Δq^-1 ⊗ q_ij).vec()                        │ │
│  │     雅可比 J = ∂Δq/∂bg                                    │ │
│  │                                                           │ │
│  │   最小二乘: (J^T*J) * δbg = J^T * 残差                    │ │
│  │   更新: Bgs[i] += δbg                                     │ │
│  └───────────────────────────────────────────────────────────┘ │
│                          ↓                                      │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ Step 2: repropagate()                                     │ │
│  │                                                           │ │
│  │   用新的 Bgs 重新积分所有IMU数据                          │ │
│  │   得到更准确的 Δp, Δv, Δq                                 │ │
│  └───────────────────────────────────────────────────────────┘ │
│                          ↓                                      │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ Step 3: optimization()                                    │ │
│  │                                                           │ │
│  │   联合优化:                                                │ │
│  │   - 11帧位姿 (Ps, Rs)                                     │ │
│  │   - 11帧速度+bias (Vs, Bas, Bgs)                          │ │
│  │   - N个特征深度                                           │ │
│  │                                                           │ │
│  │   约束:                                                    │ │
│  │   - IMU预积分约束                                         │ │
│  │   - 视觉重投影约束                                        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                          ↓                                      │
│  输出: 精化后的 Ps, Rs, Vs, Bas, Bgs, 特征深度                 │
│        solver_flag = NON_LINEAR → 初始化完成!                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```
## 四、三角化策略（实际生效的）

```
特征需要三角化?
       ↓
  ┌─ 双目模式 && 有右目匹配?
  │     YES → 双目三角化（同一帧左右相机）  ✅ 优先
  │            基线：双目外参 tic[0], tic[1]
  │
  └─ 观测帧数 > 1?
        YES → 两帧运动三角化（帧0 + 帧1 左相机）  ✅ 备选
               基线：PnP求得的帧间位姿
        
        NO  → 跳过，等待更多观测
```

**注意**：多帧SVD三角化代码存在但逻辑上永远不会执行（死代码）。

---

## 五、3D点生命周期管理

### 添加机制
- 每帧新检测的特征 → 加入feature list
- 每帧追踪到的已有特征 → 追加观测

### 移除机制（5种）

| 机制 | 触发条件 | 说明 |
|-----|---------|-----|
| **外点剔除** | 重投影误差 > 3像素 | 优化后检查 |
| **滑窗移除(旧帧)** | 观测帧数 < 2 | MARGIN_OLD时 |
| **滑窗移除(次新帧)** | 无观测 | MARGIN_SECOND_NEW时 |
| **深度失败** | solve_flag == 2 | 三角化失败 |
| **非双目匹配** | 无右目匹配 | 可选严格模式 |

---

## 六、关键区别总结

| 特性 | 单目+IMU | 双目+IMU |
|-----|---------|---------|
| **尺度来源** | IMU对齐估计 | 双目基线直接获得 |
| **初始化是否需要SFM** | ✅ 需要 | ❌ 不需要 |
| **初始化是否需要足够视差** | ✅ 需要 | ❌ 不需要 |
| **陀螺仪bias标定方式** | VisualIMUAlignment | solveGyroscopeBias |
| **是否恢复重力方向** | ✅ LinearAlignment | ❌ 使用初始位姿 |
| **初始化速度** | 慢（需要运动激励） | 快（填满窗口即可） |
| **初始化鲁棒性** | 较低 | 较高 |

---

## 七、一句话总结

> **单目靠运动恢复尺度，双目靠基线直接测深度。**
> 
> 双目初始化的核心循环是：**三角化得3D点 → PnP求新帧位姿 → 再三角化新特征**，直到窗口填满后标定陀螺仪bias完成初始化。